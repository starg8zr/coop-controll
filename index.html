<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ESP32 Relay Control Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #f9f9f9; margin: 0; padding: 0 10px 40px; display: flex; flex-direction: column; min-height: 100vh; justify-content: space-between; }
    h1 { margin-top: 30px; font-size: 1.8rem; }
    .relay-card, .card { display: inline-block; background-color: white; padding: 20px; margin: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 260px; vertical-align: top; }
    .relay-card h2, .card h2 { margin-bottom: 10px; font-size: 1.3rem; }
    .relay-card p, .relay-card label, .relay-card select, .relay-card input { margin-bottom: 10px; font-size: 1rem; display: block; }
    .relay-card button { padding: 10px 20px; border: none; border-radius: 10px; color: white; background-color: blue; cursor: pointer; font-size: 16px; width: 90%; transition: opacity 0.3s ease; }
    .relay-card button:hover { opacity: 0.8; }
    #allOffBtn, #logoutBtn { max-width: 300px; width: 90%; padding: 12px 25px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; margin: 15px auto; display: block; color: white; transition: opacity 0.3s ease; }
    #allOffBtn { background-color: #d32f2f; } #allOffBtn:hover { opacity: 0.8; }
    #logoutBtn { background-color: #555; } #logoutBtn:hover { opacity: 0.8; }
    #dashboard { display: none; }
    #loginForm { max-width: 400px; margin: 80px auto 20px; background: white; padding: 30px 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #loginForm input { width: 100%; padding: 12px 15px; margin: 10px 0 20px; font-size: 1rem; border: 1.5px solid #ccc; border-radius: 10px; box-sizing: border-box; outline-offset: 2px; transition: border-color 0.3s ease; }
    #loginForm input:focus { border-color: #1e88e5; }
    #loginForm button { width: 100%; background-color: #1e88e5; color: white; padding: 12px; font-size: 18px; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.3s ease; }
    #loginForm button:hover { background-color: #1565c0; }
    #dashboard .relay-container { max-width: 1200px; margin: 20px auto 0; display: flex; flex-wrap: wrap; justify-content: center; }
    @media (max-width: 700px) { .relay-card, .card { width: 90%; margin: 10px auto; display: block; } body { padding: 0 10px 60px; } }
    footer { font-size: 0.9rem; color: #666; padding: 10px 0; margin-top: 40px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ESP32 Relay Control Dashboard</h1>
  <div id="loginForm">
    <input type="email" id="email" placeholder="Enter Email" required />
    <input type="password" id="password" placeholder="Enter Password" required />
    <button id="loginBtn">Login</button>
  </div>
  <div id="dashboard">
    <div class="relay-container">
      <!-- Relay Cards -->
      <div class="relay-card" id="relay1Card">
        <h2>Relay 1</h2>
        <p>Status: <span id="status1">Loading...</span></p>
        <label>Mode:</label>
        <select id="relay1Mode" onchange="updateRelayMode(1)"><option value="manual">Manual</option><option value="auto">Auto</option></select>
        <label>Control by:</label>
        <select id="relay1Sensor" onchange="updateRelayMode(1)"><option value="temperature">Temperature</option><option value="humidity">Humidity</option><option value="voltage">Voltage</option></select>
        <label>Logic:</label>
        <select id="relay1Logic" onchange="updateRelayMode(1)"><option value="above">Above threshold</option><option value="below">Below threshold</option></select>
        <label>Threshold:</label>
        <input type="range" id="relay1Threshold" min="0" max="100" value="50" oninput="updateRelayMode(1)"><span id="relay1ThresholdVal">50</span>
        <button id="btn1">Toggle</button>
      </div>
      <!-- Repeat Relay 2-4 similar to Relay 1 -->
      <div class="relay-card" id="relay2Card">
        <h2>Relay 2</h2>
        <p>Status: <span id="status2">Loading...</span></p>
        <label>Mode:</label>
        <select id="relay2Mode" onchange="updateRelayMode(2)"><option value="manual">Manual</option><option value="auto">Auto</option></select>
        <label>Control by:</label>
        <select id="relay2Sensor" onchange="updateRelayMode(2)"><option value="temperature">Temperature</option><option value="humidity">Humidity</option><option value="voltage">Voltage</option></select>
        <label>Logic:</label>
        <select id="relay2Logic" onchange="updateRelayMode(2)"><option value="above">Above threshold</option><option value="below">Below threshold</option></select>
        <label>Threshold:</label>
        <input type="range" id="relay2Threshold" min="0" max="100" value="50" oninput="updateRelayMode(2)"><span id="relay2ThresholdVal">50</span>
        <button id="btn2">Toggle</button>
      </div>
      <div class="relay-card" id="relay3Card">
        <h2>Relay 3</h2>
        <p>Status: <span id="status3">Loading...</span></p>
        <label>Mode:</label>
        <select id="relay3Mode" onchange="updateRelayMode(3)"><option value="manual">Manual</option><option value="auto">Auto</option></select>
        <label>Control by:</label>
        <select id="relay3Sensor" onchange="updateRelayMode(3)"><option value="temperature">Temperature</option><option value="humidity">Humidity</option><option value="voltage">Voltage</option></select>
        <label>Logic:</label>
        <select id="relay3Logic" onchange="updateRelayMode(3)"><option value="above">Above threshold</option><option value="below">Below threshold</option></select>
        <label>Threshold:</label>
        <input type="range" id="relay3Threshold" min="0" max="100" value="50" oninput="updateRelayMode(3)"><span id="relay3ThresholdVal">50</span>
        <button id="btn3">Toggle</button>
      </div>
      <div class="relay-card" id="relay4Card">
        <h2>Relay 4</h2>
        <p>Status: <span id="status4">Loading...</span></p>
        <label>Mode:</label>
        <select id="relay4Mode" onchange="updateRelayMode(4)"><option value="manual">Manual</option><option value="auto">Auto</option></select>
        <label>Control by:</label>
        <select id="relay4Sensor" onchange="updateRelayMode(4)"><option value="temperature">Temperature</option><option value="humidity">Humidity</option><option value="voltage">Voltage</option></select>
        <label>Logic:</label>
        <select id="relay4Logic" onchange="updateRelayMode(4)"><option value="above">Above threshold</option><option value="below">Below threshold</option></select>
        <label>Threshold:</label>
        <input type="range" id="relay4Threshold" min="0" max="100" value="50" oninput="updateRelayMode(4)"><span id="relay4ThresholdVal">50</span>
        <button id="btn4">Toggle</button>
      </div>
    </div>
    <div class="relay-container">
      <!-- Sensor Values -->
      <div class="card"><h2>Temperature</h2><p><span id="tempVal">Loading...</span> °C</p><canvas id="tempChart"></canvas></div>
      <div class="card"><h2>Humidity</h2><p><span id="humVal">Loading...</span> %</p><canvas id="humChart"></canvas></div>
      <div class="card"><h2>Voltage</h2><p><span id="voltVal">Loading...</span> V</p><canvas id="voltChart"></canvas></div>
    </div>
    <button id="allOffBtn">All OFF</button>
    <button id="logoutBtn">Logout</button>
  </div>
  <footer>Created by Tech StudyCell</footer>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey: "AIzaSyChsW3vee_Aq-vTgQY7f5swcCq7wDQo0eE", authDomain: "home-4fc70.firebaseapp.com", databaseURL: "https://home-4fc70-default-rtdb.firebaseio.com", projectId: "home-4fc70", storageBucket: "home-4fc70.firebasestorage.app", messagingSenderId: "331141707198", appId: "1:331141707198:web:f015ee7e05d39cabfdb5ef" };
    firebase.initializeApp(firebaseConfig);
    const allowedEmail = "starg8zr@yahoo.com"; const allowedPassword = "12345678";
    const loginForm = document.getElementById("loginForm"), dashboard = document.getElementById("dashboard"), loginBtn = document.getElementById("loginBtn");

    loginBtn.addEventListener("click", ()=>{
      const email = document.getElementById("email").value.trim(), password = document.getElementById("password").value;
      if(!email||!password){ alert("Please enter email and password."); return; }
      if(email===allowedEmail&&password===allowedPassword){
        firebase.auth().signInWithEmailAndPassword(email,password).then(()=>{
          loginForm.style.display="none";
          dashboard.style.display="block";
          startRelayControl();
        }).catch(e=>{alert("Firebase login failed: "+e.message);});
      }else{alert("Invalid email or password.");}
    });

    function updateRelayMode(id){
      const mode=document.getElementById(`relay${id}Mode`).value,
            sensor=document.getElementById(`relay${id}Sensor`).value,
            logic=document.getElementById(`relay${id}Logic`).value,
            threshold=document.getElementById(`relay${id}Threshold`).value;
      firebase.database().ref(`/modes/relay${id}`).set({mode,sensor,logic,threshold});
      document.getElementById(`relay${id}ThresholdVal`).innerText = threshold;
    }

    function startRelayControl(){
      const db=firebase.database();
      const relays=[{id:1,path:"relay1"},{id:2,path:"relay2"},{id:3,path:"relay3"},{id:4,path:"relay4"}];
      relays.forEach(r=>{
        const statusText=document.getElementById(`status${r.id}`), toggleButton=document.getElementById(`btn${r.id}`), relayRef=db.ref("/"+r.path);
        relayRef.on("value",snap=>{const state=snap.val(); statusText.innerText=state?"ON":"OFF"; toggleButton.style.backgroundColor=state?"green":"blue";});
        toggleButton.onclick=()=>{relayRef.get().then(snap=>{relayRef.set(!snap.val());});};
      });
      document.getElementById("allOffBtn").onclick=()=>{relays.forEach(r=>{db.ref("/"+r.path).set(false);});};

      // Chart setup
      const tempCtx=document.getElementById("tempChart").getContext("2d"), humCtx=document.getElementById("humChart").getContext("2d"), voltCtx=document.getElementById("voltChart").getContext("2d");
      function makeChart(ctx,label,color){return new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label,data:[],borderColor:color,borderWidth:2,fill:false,tension:0.2}]},options:{responsive:true,animation:false}});}
      const tempChart=makeChart(tempCtx,"Temperature (°C)","red"), humChart=makeChart(humCtx,"Humidity (%)","blue"), voltChart=makeChart(voltCtx,"Voltage (V)","green");
      function updateChart(chart,value){const time=new Date().toLocaleTimeString(); chart.data.labels.push(time); chart.data.datasets[0].data.push(value); if(chart.data.labels.length>20){chart.data.labels.shift(); chart.data.datasets[0].data.shift();} chart.update();}

      db.ref("/sensors/temperature").on("value",snap=>{const val=snap.val(); document.getElementById("tempVal").innerText=val+" °C"; updateChart(tempChart,val); checkRelays('temperature',val);});
      db.ref("/sensors/humidity").on("value",snap=>{const val=snap.val(); document.getElementById("humVal").innerText=val+" %"; updateChart(humChart,val); checkRelays('humidity',val);});
      db.ref("/sensors/voltage").on("value",snap=>{const val=snap.val(); document.getElementById("voltVal").innerText=val+" V"; updateChart(voltChart,val); checkRelays('voltage',val);});

      function checkRelays(sensorType,value){
        for(let i=1;i<=4;i++){
          db.ref(`/modes/relay${i}`).get().then(snap=>{
            const {mode,sensor,logic,threshold} = snap.val() || {};
            if(mode==='auto' && sensor===sensorType){
              const relayRef=db.ref(`/relay${i}`);
              if((logic==='above' && value>=threshold) || (logic==='below' && value<=threshold)) relayRef.set(true);
              else relayRef.set(false);
            }
          });
        }
      }
    }

    document.getElementById("logoutBtn").onclick=()=>{
      firebase.auth().signOut().then(()=>{
        dashboard.style.display="none";
        loginForm.style.display="block";
        document.getElementById("email").value="";
        document.getElementById("password").value="";
      }).catch(e=>{alert("Logout failed: "+e.message);});
    };
  </script>
</body>
</html>
